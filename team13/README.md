# سرویس امکانات و حمل‌ونقل (Facilities & Transportation)

**گروه Axiom — تیم ۱۳** — پیاده‌سازی فاز ۷ (مطابق P3, P5, P7).

این اپلیکیشن Django میکروسرویس **امکانات و حمل‌ونقل** را برای سامانه وب نقشه و جغرافیای ایران پیاده‌سازی می‌کند.

---

## قابلیت‌ها

- **مکان‌ها (POI):** هتل، رستوران، بیمارستان، موزه، تفریحی — با ترجمه فارسی/انگلیسی، آدرس و مختصات
- **رویدادها:** با تاریخ و مکان و ترجمه
- **نظرات و امتیاز:** نمایش و ثبت امتیاز (۱–۵) برای مکان و رویداد (فقط کاربران لاگین‌شده)
- **جزئیات تخصصی:** هتل (ستاره، بازه قیمت)، رستوران (نوع غذا، قیمت متوسط)، موزه (ساعت، بلیط)، امکانات هر مکان (PlaceAmenity)
- **مسیریابی و ETA:** فاصله و زمان رسیدن بین دو مکان؛ در صورت تنظیم کلید نشان از API مسیریابی استفاده می‌شود؛ وگرنه محاسبهٔ تقریبی Haversine. امکانات مبدأ و مقصد و ثبت مسیر برای کاربر لاگین‌شده.
- **حالت اضطراری:** نزدیک‌ترین مراکز امدادی (بیمارستان، آتش‌نشانی، داروخانه، کلینیک) به موقعیت کاربر
- **یکپارچه با Core:** نمایش وضعیت کاربر (ورود/خروج) در هدر و احراز هویت برای امتیاز و ثبت مسیر
- **نقشه:** در لود اول تا ۲۰۰۰ مکان به‌نسبت از همهٔ انواع واکشی و روی نقشه نمایش داده می‌شود.

---

## پروژهٔ گروهی — عدم تغییر فولدرهای دیگر

برای فعالیت team13 نیازی به تغییر فایل در app404، core یا سایر پوشه‌ها نیست. مسیرها و تنظیمات از طریق `TEAM_APPS` در `.env` (یا مقدار پیش‌فرض settings) انجام می‌شود.

---

## اجرای پروژه

### روش ۱: اجرای محلی (بدون Docker)

از **ریشهٔ پروژه** (پوشهٔ حاوی `manage.py`) با Python 3.11:

```bash
pip install -r requirements.txt
pip install -r team13/requirements.txt
py -3.11 manage.py migrate
py -3.11 manage.py runserver
```

برای فعال بودن فقط اپ team13، در `.env` ریشهٔ پروژه مقدار `TEAM_APPS=team13` تنظیم شود.

TEAM_APPS=team13
# کلیدهای نشان — ذخیره شده برای مرحلهٔ بعد

NESHAN_API_KEY_SERVICE=service.4b8184b63cdb408b90a3a31feaabc6a8
NESHAN_API_KEY_WEB=web.5ee1e82db9314ba5a50806d13018c9a1


دستورات تفصیلی و بارگذاری دادهٔ نمونه در فایل **RUN_AND_TEST.md** آمده است.

### روش ۲: اجرا با Docker

برای اجرای سرویس داخل کانتینر از **ریشهٔ پروژه** دستور زیر استفاده شود:

```bash
docker network create app404_net
docker compose -f team13/docker-compose.yml up -d --build
```

پورت پیش‌فرض gateway: **8080**. جزئیات معماری، متغیرهای محیط و عیب‌یابی در **DOCKER.md** documented شده است.

---

## آدرس‌های سرویس (پیشوند `/team13/`)

| کاربرد | آدرس |
|--------|------|
| صفحهٔ اصلی | `http://localhost:8000/team13/` (محلی) یا `http://localhost:8080/team13/` (Docker) |
| مکان‌ها | `/team13/places/` |
| جزئیات مکان | `/team13/places/<place_id>/` |
| رویدادها | `/team13/events/` |
| جزئیات رویداد | `/team13/events/<event_id>/` |
| مسیریابی | `/team13/routes/` |
| مراکز امدادی | `/team13/emergency/` |
| مستندات API | `/team13/api-docs/` |
| پنل مدیریت | `/team13/admin/` یا `/team13/admin-panel/` |
| تست (نیاز به لاگین) | `/team13/ping/` |

خروجی JSON با `?format=json` یا هدر `Accept: application/json` دریافت می‌شود.

ورود به پنل مدیریت: ایمیل `admin@gmail.com`، رمز `admin` (کاربر در `team13/apps.py` پس از migrate ساخته می‌شود).

---

## پایگاه داده

- **پیش‌فرض:** SQLite مخصوص تیم در `team13/team13.sqlite3`
- **دیتابیس ابری:** متغیر `TEAM13_DATABASE_URL` در `.env`

### بارگذاری دادهٔ نمونه

از ریشهٔ پروژه، با JSON در **team13/temp_data_inseart** (hotels.json، hospitals.json، restaurants.json):

```bash
py -3.11 team13/load_temp_data.py --clear
```

جایگزین با CSV در `team13/temp_data`:

```bash
py -3.11 manage.py loaddata_team13_csv --clear
```

---

## یکپارچه‌سازی با احراز هویت Core

- وضعیت کاربر در هدر صفحات team13 نمایش داده می‌شود.
- **CORE_BASE_URL** در `.env`: در صورت مقداردهی، وضعیت کاربر از `GET CORE_BASE_URL/api/auth/me/` با ارسال کوکی گرفته می‌شود؛ در غیر این صورت از `request.user` همین سرور.
- ثبت امتیاز و ثبت مسیر فقط برای کاربران لاگین‌شده.

---

## یکپارچه‌سازی فاز ۵ و فاز ۷

- **فاز ۵:** مدل‌ها با `app_label="team13"` و `db_table="team13_*"`؛ دیتابیس با alias `team13` از طریق `core.db_router.TeamPerAppRouter`.
- **فاز ۷:** مسیرها، صفحات، نظرات/امتیاز، مسیریابی و ETA، حالت اضطراری، احراز هویت Core و UI/UX مطابق الزامات تکمیل شده‌اند.

---

## وابستگی‌ها

وابستگی‌های اصلی در `requirements.txt` ریشهٔ پروژه. وابستگی‌های تکمیلی team13 در `team13/requirements.txt` (از جمله `requests`، `Pillow`).

---

## تحویل

فایل zip با نام **P7_Axiom.zip** حاوی آخرین نسخهٔ کد.
