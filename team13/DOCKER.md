# راهنمای Docker — تیم ۱۳ (امکانات و حمل‌ونقل)

## داکر چیست و چیکار می‌کند؟

**Docker** یک پلتفرم برای ساخت، اجرا و تحویل اپلیکیشن‌ها داخل **کانتینر** است.

### کانتینر چیست؟
- یک محیط **جداسازی‌شده و سبک** است که اپلیکیشن و تمام وابستگی‌هایش (پایتون، کتابخانه‌ها، تنظیمات) را با هم نگه می‌دارد.
- مثل یک **ماشین مجازی کوچک** است، ولی به‌جای یک سیستم‌عامل کامل، از هستهٔ همین سیستم‌عامل استفاده می‌کند؛ برای همین سبک و سریع است.
- روی هر جایی که Docker نصب باشد (ویندوز، لینوکس، مک، سرور) **همان‌طور** اجرا می‌شود؛ یعنی «روی لپ‌تاپ من درست کار می‌کند، روی سرور نه» کمتر پیش می‌آید.

### داکر چیکار می‌کند؟
1. **یکسان‌سازی محیط**: همه (توسعه‌دهنده، تست، سرور) با همان نسخهٔ پایتون و همان کتابخانه‌ها کار می‌کنند.
2. **ساده‌سازی اجرا**: به‌جای نصب دستی پایتون و وابستگی‌ها، فقط `docker compose up` می‌زنید و سرویس بالا می‌آید.
3. **جداسازی**: اپلیکیشن تیم ۱۳ داخل کانتینر خودش اجرا می‌شود؛ با بقیهٔ برنامه‌های روی سیستم تداخل ندارد.
4. **آماده برای استقرار**: همان image را می‌توان روی سرور یا سرویس ابری اجرا کرد.

### اصطلاحات مهم
- **Image (تصویر)**: قالبِ فقط‌خواندنیِ یک اپلیکیشن (مثل یک CD). از روی Dockerfile ساخته می‌شود.
- **Container (کانتینر)**: یک نمونهٔ **در حال اجرا** از یک image. می‌توان چند کانتینر از یک image داشت.
- **Dockerfile**: دستورالعمل ساخت یک image (نصب پایتون، کپی فایل‌ها، اجرای دستورات).
- **docker-compose**: تعریف چند سرویس (مثلاً بک‌اند + nginx) با هم؛ با یک دستور همه را بالا می‌آورد.

---

## معماری Docker در این پروژه

```
  کاربر (مرورگر)
       │
       ▼  http://localhost:8080
  ┌─────────────┐
  │   Gateway   │  ← nginx روی پورت 8080
  │  (nginx)    │
  └──────┬──────┘
         │ proxy
         ▼
  ┌─────────────┐
  │   Backend   │  ← Django + Gunicorn روی پورت 8000 (داخلی)
  │  (Django)   │     شامل اپ team13 و مسیرهای /team13/
  └─────────────┘
```

- **Gateway (nginx)**: درخواست‌های HTTP را می‌گیرد و به کانتینر بک‌اند **پروکسی** می‌کند. می‌توان بعداً کش، SSL یا مسیرهای دیگر هم به آن اضافه کرد.
- **Backend**: همان پروژهٔ Django (app404 + team13) با Gunicorn اجرا می‌شود؛ مایگریشن و استاتیک طبق تنظیمات پروژه است.

---

## پیش‌نیاز

1. نصب **Docker Desktop** (ویندوز/مک) یا **Docker Engine** + **Docker Compose** (لینوکس).
2. شبکهٔ مشترک پروژه (یک بار از **ریشهٔ پروژه**):

   ```bash
   docker network create app404_net
   ```

   اگر از قبل وجود دارد، خطا می‌دهد؛ مشکلی نیست.

---

## دستورات اجرا

همهٔ دستورات زیر را از **ریشهٔ پروژه** (جایی که `manage.py` و پوشهٔ `team13` هست) اجرا کنید.

### ساخت و اجرا

```bash
docker compose -f team13/docker-compose.yml up -d --build
```

- `--build`: اول image بک‌اند را از روی Dockerfile می‌سازد.
- `-d`: در پس‌زمینه اجرا می‌شود (detached).

### مشاهدهٔ لاگ

```bash
docker compose -f team13/docker-compose.yml logs -f
```

### توقف

```bash
docker compose -f team13/docker-compose.yml down
```

با `down` کانتینرها و شبکهٔ داخلی compose متوقف می‌شوند؛ **volume** (دادهٔ دیتابیس) باقی می‌ماند. برای حذف volume هم:

```bash
docker compose -f team13/docker-compose.yml down -v
```

---

## دسترسی به سرویس

بعد از `up -d`:

- **صفحهٔ اصلی تیم ۱۳**:  
  [http://localhost:8080/team13/](http://localhost:8080/team13/)
- پورت پیش‌فرض **8080** است؛ با متغیر محیطی `TEAM_PORT` در `.env` یا قبل از دستور قابل تغییر است، مثلاً:

  ```bash
  TEAM_PORT=9000 docker compose -f team13/docker-compose.yml up -d
  ```

---

## فایل‌های مهم

| فایل | کاربرد |
|------|--------|
| **Dockerfile** | تعریف image بک‌اند: پایتون ۳.۱۱، نصب وابستگی‌ها، کپی پروژه، اجرای migrate و Gunicorn. |
| **docker-compose.yml** | تعریف سرویس‌های `backend` و `gateway`، شبکهٔ `app404` و volume برای داده. |
| **gateway.conf** | پیکربندی nginx: دریافت درخواست روی پورت ۸۰ و پروکسی به `http://backend:8000`. |
| **env.docker.example** | نمونهٔ متغیرهای محیط برای پورت و (اختیاری) کلیدها و آدرس Core. |

---

## Volume و داده

- **team13_data**: یک volume با این نام برای مسیر `/app/data` داخل کانتینر بک‌اند تعریف شده است.
- دیتابیس SQLite تیم ۱۳ با `TEAM13_DATABASE_URL=sqlite:///app/data/team13.sqlite3` در همین مسیر ساخته می‌شود؛ با هر بار راه‌اندازی مجدد، داده از بین نمی‌رود مگر آن که با `down -v` volume را حذف کنید.

---

## عیب‌یابی

- **شبکه وجود ندارد**:  
  `docker network create app404_net`
- **پورت 8080 اشغال است**:  
  در `.env` یا قبل از دستور `TEAM_PORT=9000` (یا هر پورت آزاد) بگذارید.
- **خطای مایگریشن یا دیتابیس**:  
  با `docker compose -f team13/docker-compose.yml logs backend` لاگ بک‌اند را ببینید؛ در صورت نیاز volume را با `down -v` حذف و دوباره `up -d --build` کنید تا از اول ساخته شود.

با این تنظیمات، Docker برای شما محیط یکسان و قابل حمل برای اجرا و تحویل سرویس امکانات و حمل‌ونقل (تیم ۱۳) فراهم می‌کند.
